<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Cars Demo: JS13K MMO Challenge Series</title>
    <meta name="title" content="Cars Demo: JS13K MMO Challenge Series" />
    <meta name="description" content="Cars Demo: JS13K MMO Challenge Series" />
    <meta name="author" content="benallfree" />
    <style>
      body {
        background-color: #ffffff;
      }
      .status-indicator {
        position: fixed;
        top: 10px;
        right: 10px;
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        color: white;
        transition: background-color 0.3s ease;
      }

      .status-connecting {
        background-color: #f39c12;
      }

      .status-connected {
        background-color: #27ae60;
      }

      .status-disconnected {
        background-color: #e74c3c;
      }

      .controls {
        position: fixed;
        top: 10px;
        left: 10px;
        display: flex;
        gap: 8px;
        padding: 8px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .control-btn {
        padding: 8px 12px;
        border: 2px solid #ddd;
        border-radius: 4px;
        background: white;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.2s ease;
      }

      .control-btn:hover {
        background: #f0f0f0;
        border-color: #999;
      }

      .control-btn.active {
        background: #007bff;
        color: white;
        border-color: #0056b3;
      }

      .game-container {
        position: fixed;
        top: 60px;
        left: 10px;
        right: 10px;
        bottom: 10px;
        background: #2c5e1e;
        border-radius: 8px;
        overflow: hidden;
      }

      #gameCanvas {
        display: block;
        cursor: crosshair;
      }

      .instructions {
        position: fixed;
        bottom: 20px;
        left: 20px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 12px;
        border-radius: 8px;
        font-size: 14px;
        max-width: 300px;
      }
    </style>
    <script type="module">
      import Js13kClient from '/sdk.js'

      // Create status indicator
      const statusIndicator = document.createElement('div')
      statusIndicator.className = 'status-indicator status-connecting'
      statusIndicator.textContent = 'Connecting...'
      document.body.appendChild(statusIndicator)

      // Create client with delta evaluator
      const client = new Js13kClient('cars', {
        deltaEvaluator: (delta, shadowState, playerId) => {
          // console.log(`deltaEvaluator: ${JSON.stringify({ delta, shadowState, playerId }, null, 2)}`)
          // If no base state, always send
          if (!shadowState || !playerId) {
            return true
          }

          // Get the player's previous state from the delta base
          const playerBase = shadowState.players?.[playerId]
          if (!playerBase) {
            return true
          }
          // console.log(`playerBase: ${JSON.stringify({ playerBase, delta, shadowState }, null, 2)}`)

          // Check if x, y, or angle have changed significantly
          const newX = delta.players?.[playerId]?.x
          const newY = delta.players?.[playerId]?.y
          const newAngle = delta.players?.[playerId]?.angle

          const xChanged = newX != null && (playerBase.x == null || Math.abs(newX - playerBase.x) > 2)
          const yChanged = newY != null && (playerBase.y == null || Math.abs(newY - playerBase.y) > 2)
          const angleChanged =
            newAngle != null && (playerBase.angle == null || Math.abs(newAngle - playerBase.angle) > 0.05)

          const hasChanged = xChanged || yChanged || angleChanged
          // console.log(`hasChanged: ${hasChanged}`, { xChanged, yChanged, angleChanged })
          return hasChanged
        },
      })

      // Game state
      let keys = {
        ArrowUp: false,
        ArrowDown: false,
        ArrowLeft: false,
        ArrowRight: false,
      }

      // Canvas setup
      const canvas = document.getElementById('gameCanvas')
      const ctx = canvas.getContext('2d')

      // Set canvas size to fill container
      function resizeCanvas() {
        const container = canvas.parentElement
        canvas.width = container.clientWidth
        canvas.height = container.clientHeight
      }

      // Initial resize
      resizeCanvas()

      // Resize on window resize
      window.addEventListener('resize', resizeCanvas)

      // Car colors for different players
      const carColors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#ffa500', '#800080']

      // Draw a car
      function drawCar(x, y, angle, color, isMyCar = false) {
        ctx.save()
        ctx.translate(x, y)
        ctx.rotate(angle)

        // Car body
        ctx.fillStyle = color
        ctx.fillRect(-15, -8, 30, 16)

        // Car roof
        ctx.fillRect(-8, -12, 16, 8)

        // Wheels
        ctx.fillStyle = '#333'
        ctx.fillRect(-12, -10, 4, 20)
        ctx.fillRect(8, -10, 4, 20)

        // Headlights
        ctx.fillStyle = '#ffff00'
        ctx.fillRect(-12, -6, 3, 3)
        ctx.fillRect(-12, 3, 3, 3)

        // My car gets a special indicator
        if (isMyCar) {
          ctx.fillStyle = '#fff'
          ctx.font = '12px Arial'
          ctx.textAlign = 'center'
          ctx.fillText('YOU', 0, -20)
        }

        ctx.restore()
      }

      // Render the current state to canvas
      function renderState() {
        // Clear canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height)

        // Draw grass pattern
        ctx.fillStyle = '#2c5e1e'
        ctx.fillRect(0, 0, canvas.width, canvas.height)

        // Draw some road lines
        ctx.strokeStyle = '#fff'
        ctx.lineWidth = 2
        ctx.setLineDash([20, 20])
        ctx.beginPath()
        ctx.moveTo(canvas.width / 2, 0)
        ctx.lineTo(canvas.width / 2, canvas.height)
        ctx.stroke()
        ctx.setLineDash([])

        // Render all cars from state
        const state = client.getState()
        if (state.players) {
          for (const playerId in state.players) {
            const car = state.players[playerId]
            const color = carColors[parseInt(playerId) % carColors.length]
            const isMyCar = playerId === client.getMyId()
            drawCar(car.x, car.y, car.angle, color, isMyCar)
          }
        }
      }

      // Update car position based on keys
      function updateCar() {
        const car = client.getMyState(true) // Get deep copy since we'll modify it
        if (!car) {
          return
        }

        let moved = false

        if (keys.ArrowUp) {
          car.x -= Math.cos(car.angle) * 3
          car.y -= Math.sin(car.angle) * 3
          moved = true
          console.log('Moving forward', car.x, car.y)
        }
        if (keys.ArrowDown) {
          car.x += Math.cos(car.angle) * 2
          car.y += Math.sin(car.angle) * 2
          moved = true
          console.log('Moving backward', car.x, car.y)
        }
        if (keys.ArrowLeft) {
          car.angle -= 0.1
          moved = true
          console.log('Turning left', car.angle)
        }
        if (keys.ArrowRight) {
          car.angle += 0.1
          moved = true
          console.log('Turning right', car.angle)
        }

        // Keep car within bounds
        car.x = Math.max(20, Math.min(canvas.width - 20, car.x))
        car.y = Math.max(20, Math.min(canvas.height - 20, car.y))

        if (moved) {
          // Send update to server
          client.updateMyState(car)
        }
      }

      // Handle SDK events
      client.on('connected', () => {
        console.log('connected')
        statusIndicator.className = 'status-indicator status-connected'
        statusIndicator.textContent = 'Connected'
      })

      client.on('disconnected', () => {
        console.log('disconnected')
        statusIndicator.className = 'status-indicator status-disconnected'
        statusIndicator.textContent = 'Disconnected'
      })

      client.on('id', (id) => {
        console.log('Received my ID from server:', id)

        // Initialize my car
        const initialCar = {
          x: canvas.width / 2,
          y: canvas.height / 2,
          angle: 0,
        }
        console.log('Initialized my car:', initialCar)
        // Send initial position
        client.updateMyState(initialCar)
      })

      client.on('connect', (playerId) => {
        console.log('Client connected:', playerId)
        // No need to do anything special, they'll send their car data via delta
      })

      client.on('disconnect', (playerId) => {
        console.log('Client disconnected:', playerId)
        // SDK automatically handles removing disconnected players from state
      })

      client.on('state', (state) => {
        console.log('Received initial state:', state)
        // No need to do anything special, the client will initialize its own car upon receiving ID
      })

      client.on('delta', (delta) => {
        console.log('Received delta:', delta)
      })

      // Handle key events
      document.addEventListener('keydown', (event) => {
        if (keys.hasOwnProperty(event.key)) {
          keys[event.key] = true
          console.log('Key pressed:', event.key)
          event.preventDefault()
        }
      })

      document.addEventListener('keyup', (event) => {
        if (keys.hasOwnProperty(event.key)) {
          keys[event.key] = false
          console.log('Key released:', event.key)
          event.preventDefault()
        }
      })

      // Game loop
      function gameLoop() {
        updateCar()
        renderState()
        requestAnimationFrame(gameLoop)
      }

      // Start game loop
      gameLoop()
    </script>
  </head>
  <body>
    <div class="controls">
      <div class="control-btn" id="up-btn">⬆️ Up</div>
      <div class="control-btn" id="down-btn">⬇️ Down</div>
      <div class="control-btn" id="left-btn">⬅️ Left</div>
      <div class="control-btn" id="right-btn">➡️ Right</div>
    </div>
    <div class="game-container">
      <canvas id="gameCanvas"></canvas>
    </div>
    <div class="instructions">
      <strong>Controls:</strong><br />
      Arrow keys to drive<br />
      Each player gets a unique colored car<br />
      Your car is marked with "YOU"
    </div>
  </body>
</html>
